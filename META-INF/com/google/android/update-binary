#!/sbin/sh
# Author: cjybyjk (cjybyjk@gmail.com)
# script for removing Project WIPE
# supported platform: any supported in Project WIPE

OUTFD=$2
ZIP=$3

# Detect whether in boot mode
ps | grep zygote | grep -v grep >/dev/null && BOOTMODE=true || BOOTMODE=false
$BOOTMODE || ps -A 2>/dev/null | grep zygote | grep -v grep >/dev/null && BOOTMODE=true
$BOOTMODE || id | grep -q 'uid=0' || BOOTMODE=true

ui_print() {
	$BOOTMODE && echo "$1" || echo -e "ui_print $1\nui_print" >> /proc/self/fd/$OUTFD
}

ui_print " "
ui_print "**************************"
ui_print "  Project WIPE remover"
ui_print "  Authors:"
ui_print "  Project WIPE: yc9559"
ui_print "  ZIP flashable: cjybyjk"
ui_print "**************************"
ui_print " "

TMPDIR=/dev/tmp_WIPE

ui_print "- Mounting /system, /vendor and /data"
mount /system
mount /vendor
mount /data

ui_print "- Extracting files"
mkdir -p $TMPDIR
cd $TMPDIR
unzip -o "$ZIP" > /dev/null

ui_print "- Reomving files"
rm -f /system/xbin/powercfg
rm -f /system/bin/powercfg
rm -f /system/bin/powercfg_real
mkdir ./mountimg
while read lineinText
do 
    fileFormat=`echo $lineinText | awk '{print \$1}'`
    pathtofile=`echo $lineinText | awk -F \" '{print \$2}'`
    bootinIMG=`echo $lineinText | awk -F \" '{print \$4}'`
    pathinIMG=`echo $lineinText | awk -F \" '{print \$6}'`
    case "$fileFormat" in
    "[D]" )
        if [ -d "$pathtofile" ]; then
            ui_print "  $pathtofile found, removing files..."
            rm -f "$pathtofile/99prjwipe"
        fi
    ;;
    "[F]" )
        if [ -f "$pathtofile" ]; then
            # restore backup
            if [ -f "$pathtofile.wipebak" ]; then
                ui_print "  backup of $pathtofile found,restoring"
                rm -f "$pathtofile"
                mv "$pathtofile.wipebak" "$pathtofile"
            fi
        fi
    ;;
    "[I]" )
        if [ -f "$pathtofile" ]; then
            ui_print "  $pathtofile found, mounting..."
            mount "$pathtofile" ./mountimg
            if [ -d ./mountimg/$pathinIMG ]; then
                ui_print "  removing powercfg to $pathinIMG..."
                rm ./mountimg/$pathinIMG/powercfg
                rm ./mountimg/$pathinIMG/powercfg_real
            fi
            ui_print "  removing file on $bootinIMG..."
            rm -f "./mountimg/$bootinIMG/99prjwipe"
            ui_print "  Unmounting $pathtofile"
            umount ./mountimg
        fi
    ;;
    esac
done < ./list_of_bootable
ui_print "  Mounting magisk.img"
mkdir magisk
magiskFlag=false
if [ -f "/data/magisk.img" ]; then
    mount /data/magisk.img magisk
elif [ -f "/data/adb/magisk.img"]; then
    mount /data/adb/magisk.img magisk
fi
ui_print "  Removing magisk module (id:prjWIPE)"
rm -rf magisk/prjWIPE
umount magisk

ui_print "  Removing wipe_mode"
rm -f /sdcard/wipe_mode

if [ -L "/data/powercfg" ]; then
    ui_print "  Removing powercfg (symbol link) on /data"
    rm /data/powercfg
fi

ui_print "- Cleaning files"
cd /
rm -rf $TMPDIR

ui_print "- Unmouting /system, /vendor"
umount /system
umount /vendor

ui_print "- Done!"
exit 0
